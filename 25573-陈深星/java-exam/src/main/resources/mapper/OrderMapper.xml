<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.exam.mapper.OrderMapper">

    <!-- orderMap -->
    <resultMap id="orderMap" type="com.exam.entity.Order">

        <id column="id" property="id"></id>

        <result column="user_id" property="user_id"></result>
        <result column="number" property="number"></result>
        <result column="createtime" property="createtime"></result>
        <result column="note" property="note"></result>

    </resultMap>

    <!-- 根据id查询订单 -->
    <select id="findOrderById" parameterType="java.lang.Integer" resultMap="orderMap">

        SELECT * FROM `orders` WHERE `id` = #{id};

    </select>

    <!-- 根据id查询订单及其对应的用户账号 -->
    <resultMap id="orderAndUserMap" type="com.exam.entity.OrderExt">

        <id column="id" property="id"></id>

        <result column="user_id" property="userId"></result>
        <result column="number" property="number"></result>
        <result column="createtime" property="createtime"></result>
        <result column="note" property="note"></result>


        <!-- 懒加载 -->
        <association property="user" javaType="com.exam.entity.User">

            <id column="user_id" property="id"></id>

            <result column="username" property="username"></result>
            <result column="address" property="address"></result>

        </association>

    </resultMap>

    <select id="findOrderExt" resultMap="orderAndUserMap">

        SELECT
        o.*, u.`username`, u.`address`
        FROM
        `user` u,
        `orders` o
        WHERE
        u.`id` = o.`user_id`
        <if test="id != null">
            AND o.`id` = #{id};
        </if>

    </select>

    <resultMap id="orderAndOrderDetailMap" type="com.exam.entity.OrderExt" extends="orderAndUserMap">

        <collection property="orderDetailList" ofType="com.exam.entity.OrderDetail">

            <id column="detail_id" property="id"></id>

            <result column="items_id" property="itemsId"></result>
            <result column="items_num" property="itemsNum"></result>

        </collection>

    </resultMap>

    <select id="findDrderAndOrderDetail" resultMap="orderAndOrderDetailMap">

        SELECT
        u.`username`,
        u.`sex`,
        o.`id`,
        o.`user_id`,
        o.`number`,
        od.`id` 'detail_id',
        od.`items_id`,
        od.`items_num`
        FROM
        `user` u,
        `orders` o,
        `orderdetail` od
        WHERE
        u.`id` = o.`user_id` AND o.`id` = od.`orders_id`
        <if test="number != null">
            AND o.`number` = #{id}
        </if>
        <if test="createtime != null">
            AND  o.`createtime` = #{id};
        </if>

    </select>

    <!-- ********** 一对多映射 ********** -->

</mapper>